<link rel="import"
  href="/bower_components/google-map/google-map.html">
<link rel="import"
  href="/bower_components/google-map/google-map-directions.html">
<link rel="import"
  href="/bower_components/google-apis/google-maps-api.html">

<link rel="import"
  href="/elements/bsd-globals/bsd-globals.html">
<link rel="import"
  href="/elements/bsd-endpoint/bsd-endpoint.html">
<link rel="import"
  href="/elements/bsd-distance-estimator/bsd-distance-estimator.html">

<polymer-element name="bsd-main">
  <template>
    <bsd-globals id="globals" lat={{startLat}} lng={{startLng}}></bsd-globals>
    <bsd-endpoint id="origin" label="From" stations="{{originStations}}"></bsd-endpoint>
    <bsd-endpoint id="destination" label="To" stations="{{destinationStations}}"></bsd-endpoint>
    <bsd-distance-estimator origins={{originStations}}
      destinations={{destinationStations}}
      mode="bicycling"
      on-distance-response={{onDistance}}>
    </bsd-distance-estimator>
    <google-maps-api id="api"
      apiKey="AIzaSyAaulJg7NxcxI-zZMoPOqTce91cyXy3bfw"
      version="3.exp"></google-maps-api>
    <template if={{showMap}}>
      <google-map map={{map}}
        fitToMarkers=true
        apiKey="AIzaSyAaulJg7NxcxI-zZMoPOqTce91cyXy3bfw"
        latitude={{startLat}}
        longitude={{startLng}}
        zoomable=false>
        <template if={{$.origin.located}}>
          <google-map-marker latitude="{{$.origin.endpointLocation.lat}}"
            longitude="{{$.origin.endpointLocation.lng}}"
            title="{{$.origin.endpointLocation.name}}"
            icon="images/markers/origin.png">
          </google-map-marker>
        </template>
        <template if={{$.destination.located}}>
          <google-map-marker latitude="{{$.destination.endpointLocation.lat}}"
            longitude="{{$.destination.endpointLocation.lng}}"
            title="{{$.destination.endpointLocation.name}}"
            icon="images/markers/destination.png">
          </google-map-marker>
        </template>
        <template repeat="{{station in originStations}}">
          <google-map-marker latitude="{{station.lat}}"
            longitude="{{station.lng}}"
            title="{{station.name}}"
            icon="images/markers/numbers-closed/number_{{station.bikes}}.png"
            clickEvents=true
            on-google-map-marker-click={{onOriginMarkerClick}}>
          </google-map-marker>
        </template>
        <template repeat="{{station in destinationStations}}">
          <google-map-marker latitude="{{station.lat}}"
            longitude="{{station.lng}}"
            title="{{station.name}}"
            icon="images/markers/numbers-open/number_{{station.docks}}.png"
            clickEvents=true
            on-google-map-marker-click={{onDestinationMarkerClick}}>
          </google-map-marker>
        </template>
      </google-map>
      <google-map-directions map="{{map}}"
        apiKey="AIzaSyAaulJg7NxcxI-zZMoPOqTce91cyXy3bfw"
        startAddress="{{toLatLng($.origin.endpointLocation)}}"
        endAddress="{{activeOriginStationLatLng}}"
        travelMode="WALKING"
        on-google-map-response="{{onMapResponse}}"
        rendererOptions="{{directionsOptions}}"
        panel="{{$.firstpanel}}"></google-map-directions>
      <google-map-directions map="{{map}}"
        apiKey="AIzaSyAaulJg7NxcxI-zZMoPOqTce91cyXy3bfw"
        startAddress="{{activeOriginStationLatLng}}"
        endAddress="{{activeDestinationStationLatLng}}"
        travelMode="BICYCLING"
        rendererOptions="{{directionsOptions}}"
        panel="{{$.secondpanel}}"></google-map-directions>
      <google-map-directions map="{{map}}"
        apiKey="AIzaSyAaulJg7NxcxI-zZMoPOqTce91cyXy3bfw"
        startAddress="{{activeDestinationStationLatLng}}"
        endAddress="{{toLatLng($.destination.endpointLocation)}}"
        travelMode="WALKING"
        rendererOptions="{{directionsOptions}}"
        panel="{{$.thirdpanel}}"></google-map-directions>
    </template>
    <div id="firstpanel"></div>
    <div id="secondpanel"></div>
    <div id="thirdpanel"></div>
  </template>
  <script>
    Polymer({
      ready: function() {
        this.directionsOptions =
          {
            suppressMarkers: true,
            preserveViewport: true
          };
      },
      originStationsChanged: function() {
        if (this.originStations.length > 0) {
          this.showMap = true;
        }
      },
      destinationStationsChanged: function() {
        if (this.destinationStations.length > 0) {
          this.showMap = true;
        }
      },
      toLatLng: function(place) {
        if (!place) {
          return null;
        }

        return new this.$.api.api.LatLng(place.lat, place.lng);
      },
      onOriginMarkerClick: function(e) {
        this.activeOriginStationLatLng = new this.$.api.api.LatLng(e.target.latitude, e.target.longitude);
      },
      onDestinationMarkerClick: function(e) {
        this.activeDestinationStationLatLng = new this.$.api.api.LatLng(e.target.latitude, e.target.longitude);
      },
      onDistance: function(e) {
        // TODO find optimum
        console.log(e.detail.response)
      }
    });
  </script>
</polymer-element>

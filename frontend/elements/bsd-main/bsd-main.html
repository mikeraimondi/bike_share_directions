<link rel="import"
  href="/bower_components/google-map/google-map.html">
<link rel="import"
  href="/bower_components/google-map/google-map-directions.html">
<link rel="import"
  href="/bower_components/google-apis/google-maps-api.html">

<link rel="import"
  href="/elements/bsd-globals/bsd-globals.html">
<link rel="import"
  href="/elements/bsd-endpoint/bsd-endpoint.html">
<link rel="import"
  href="/elements/bsd-distance-estimator/bsd-distance-estimator.html">

<polymer-element name="bsd-main">
  <template>
    <bsd-globals id="globals" lat="{{startLat}}" lng="{{startLng}}"></bsd-globals>
    <bsd-endpoint id="origin" label="From" stations="{{originStations}}"></bsd-endpoint>
    <bsd-endpoint id="destination" label="To" stations="{{destinationStations}}"></bsd-endpoint>
    <bsd-distance-estimator origins="{{originStations}}"
      destinations="{{destinationStations}}"
      mode="bicycling"
      on-distance-response="{{onDistance}}">
    </bsd-distance-estimator>
    <google-maps-api id="api"
      apiKey="AIzaSyCQZMy9TAgOF_6sizNtirP9AGdgsGVlBRY"
      version="3.exp"></google-maps-api>
    <template if="{{showMap}}">
      <google-map map="{{map}}"
        fitToMarkers=true
        apiKey="AIzaSyCQZMy9TAgOF_6sizNtirP9AGdgsGVlBRY"
        latitude="{{startLat}}"
        longitude="{{startLng}}"
        zoomable=false>
        <template if="{{$.origin.located}}">
          <google-map-marker latitude="{{$.origin.endpointLocation.lat}}"
            longitude="{{$.origin.endpointLocation.lng}}"
            title="{{$.origin.endpointLocation.name}}"
            icon="images/markers/origin.png">
          </google-map-marker>
        </template>
        <template if="{{$.destination.located}}">
          <google-map-marker latitude="{{$.destination.endpointLocation.lat}}"
            longitude="{{$.destination.endpointLocation.lng}}"
            title="{{$.destination.endpointLocation.name}}"
            icon="images/markers/destination.png">
          </google-map-marker>
        </template>
        <template repeat="{{station in originStations}}">
          <google-map-marker latitude="{{station.lat}}"
            longitude="{{station.lng}}"
            title="{{station.name}}"
            icon="images/markers/numbers-closed/number_{{station.bikes}}.png"
            clickEvents=true
            on-google-map-marker-click="{{onOriginMarkerClick}}">
          </google-map-marker>
        </template>
        <template repeat="{{station in destinationStations}}">
          <google-map-marker latitude="{{station.lat}}"
            longitude="{{station.lng}}"
            title="{{station.name}}"
            icon="images/markers/numbers-open/number_{{station.docks}}.png"
            clickEvents=true
            on-google-map-marker-click="{{onDestinationMarkerClick}}">
          </google-map-marker>
        </template>
      </google-map>
      <google-map-directions map="{{map}}"
        apiKey="AIzaSyCQZMy9TAgOF_6sizNtirP9AGdgsGVlBRY"
        startAddress="{{toLatLng($.origin.endpointLocation)}}"
        endAddress="{{activeOriginStationLatLng}}"
        travelMode="WALKING"
        on-google-map-response="{{onMapResponse}}"
        rendererOptions="{{walkingDirectionsOpts}}"
        panel="{{$.firstpanel}}"></google-map-directions>
      <google-map-directions map="{{map}}"
        apiKey="AIzaSyCQZMy9TAgOF_6sizNtirP9AGdgsGVlBRY"
        startAddress="{{activeOriginStationLatLng}}"
        endAddress="{{activeDestinationStationLatLng}}"
        travelMode="BICYCLING"
        rendererOptions="{{bikingDirectionsOpts}}"
        panel="{{$.secondpanel}}"></google-map-directions>
      <google-map-directions map="{{map}}"
        apiKey="AIzaSyCQZMy9TAgOF_6sizNtirP9AGdgsGVlBRY"
        startAddress="{{activeDestinationStationLatLng}}"
        endAddress="{{toLatLng($.destination.endpointLocation)}}"
        travelMode="WALKING"
        rendererOptions="{{walkingDirectionsOpts}}"
        panel="{{$.thirdpanel}}"></google-map-directions>
    </template>
    <div id="firstpanel"></div>
    <div id="secondpanel"></div>
    <div id="thirdpanel"></div>
  </template>
  <script>
    Polymer({
      ready: function() {
        this.walkingDirectionsOpts =
          {
            suppressMarkers: true,
            preserveViewport: true
          };
        this.bikingDirectionsOpts = Object.create(this.walkingDirectionsOpts)
        this.bikingDirectionsOpts.polylineOptions =
          {
            strokeColor: "red"
          };
      },
      originStationsChanged: function() {
        if (this.originStations.length > 0) {
          this.originStations.sort(this.compare)
          this.activeOriginStationLatLng = this.toLatLng(this.originStations[0]);
          this.destinationStations.sort(this.compare)
          this.activeDestinationStationLatLng = this.toLatLng(this.destinationStations[0]);
          this.showMap = true;
        }
      },
      destinationStationsChanged: function() {
        if (this.destinationStations.length > 0) {
          this.originStations.sort(this.compare)
          this.activeOriginStationLatLng = this.toLatLng(this.originStations[0]);
          this.destinationStations.sort(this.compare)
          this.activeDestinationStationLatLng = this.toLatLng(this.destinationStations[0]);
          this.showMap = true;
        }
      },
      compare: function(a, b) {
        var aScore = a.originScore + a.destinationScore;
        var bScore = b.originScore + b.destinationScore;
        if (!aScore || !bScore) {
          return 0;
        }
        if (aScore < bScore) {
          return -1;
        }
        if (aScore > bScore) {
          return 1;
        }
        return 0;
      },
      toLatLng: function(place) {
        if (!place) {
          return null;
        }

        return new this.$.api.api.LatLng(place.lat, place.lng);
      },
      onOriginMarkerClick: function(e) {
        this.activeOriginStationLatLng = new this.$.api.api.LatLng(e.target.latitude, e.target.longitude);
      },
      onDestinationMarkerClick: function(e) {
        this.activeDestinationStationLatLng = new this.$.api.api.LatLng(e.target.latitude, e.target.longitude);
      }
    });
  </script>
</polymer-element>

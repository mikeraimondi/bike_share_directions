<link rel="import"
  href="/bower_components/google-apis/google-maps-api.html">

<polymer-element name="bsd-distance-estimator" attributes="origins destinations mode">
  <template>
    <google-maps-api id="maps"
      apiKey="AIzaSyAaulJg7NxcxI-zZMoPOqTce91cyXy3bfw"
      version="3.exp">
  </template>
  <script>
    Polymer({
      origins: [],
      destinations: [],
      originsChanged: function() {
        this.getDistances();
      },
      destinationsChanged: function() {
        this.getDistances();
      },
      getDistances: function() {
        if (this.origins.length > 0 && this.destinations.length > 0) {
          var api = this.$.maps.api

          var origins = this.origins.map(function(origin) {
            return new api.LatLng(origin.lat, origin.lng);
          });
          var destinations = this.destinations.map(function(destination) {
            return new api.LatLng(destination.lat, destination.lng);
          });

          var service = new api.DistanceMatrixService();
          var self = this;
          service.getDistanceMatrix(
            {
              origins: origins,
              destinations: destinations,
              travelMode: api.TravelMode[this.mode.toUpperCase()],
              unitSystem: api.UnitSystem.IMPERIAL
            }, function(response, status) {
              if (status === "OK") {
                var estimates = [];
                response.rows.forEach(function(row, i) {
                  row.elements.forEach(function(estimate, j) {
                    self.origins[i].originScore = estimate.duration.value;
                    self.destinations[j].destinationScore = estimate.duration.value;
                    estimates.push({
                      origin: self.origins[i],
                      destination: self.destinations[j],
                      distance: estimate.distance,
                      duration: estimate.duration
                    });
                  });
                });
                self.fire('distance-response', {response: estimates});
              } else {
                self.fire('distance-error');
              }
            }
          );
        }
      }
    });
  </script>
</polymer-element>

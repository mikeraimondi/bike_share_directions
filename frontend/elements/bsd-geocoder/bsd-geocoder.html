<link rel="import"
  href="/bower_components/paper-input/paper-input-decorator.html">
<link rel="import"
  href="/bower_components/google-apis/google-maps-api.html">

<link rel="import"
  href="/elements/bsd-globals/bsd-globals.html">

<polymer-element name="bsd-geocoder"
  attributes="location located label">
  <template>
    <bsd-globals id="globals"></bsd-globals>
    <google-maps-api id="maps"
      apiKey="AIzaSyCQZMy9TAgOF_6sizNtirP9AGdgsGVlBRY"
      version="3.exp"></google-maps-api>
    <paper-input-decorator label="{{label}}"
      isInvalid="{{located===false}}"
      error="Please enter a recognized address">
      <input id="geocodeInput" is="core-input" value="{{inputVal}}" required>
    </paper-input-decorator>
  </template>
  <script>
    Polymer({
      ready: function() {
        var self = this;
        this.$.maps.addEventListener('api-load', function() {
          self.autocomplete = new this.api.places.Autocomplete(
            self.$.geocodeInput,
            { types: ['geocode'], componentRestrictions: {country: 'us'} });
          self.$.globals.addEventListener('user.located', function(e) {
            self.autocomplete.setBounds(this.bounds);
          });
          this.api.event.addListener(self.autocomplete, 'place_changed', function() {
            var place = self.autocomplete.getPlace();
            if (place.geometry) {
              self.location =
                {
                  lat: place.geometry.location.lat(),
                  lng: place.geometry.location.lng(),
                  name: place.name
                };
              self.located = true;
            } else {
              self.location = null;
              self.located = false;
            }
          });
        });
      },
    });
  </script>
</polymer-element>
